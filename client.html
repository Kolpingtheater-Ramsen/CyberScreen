<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Socket Client</title>
    <style>
      /* Fullscreen Video */
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        background-color: black;
      }

      div {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 100%;
        position: relative;
      }

      video,
      img {
        position: absolute;
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      video {
        z-index: 1;
      }

      /* Ignore overflow */
      body {
        overflow: hidden;
      }
    </style>
  </head>

  <body>
    <div>
      <video id="liveVideo" autoplay muted></video>
      <video id="aiVideo" autoplay muted></video>
      <video id="clipVideo" muted></video>
      <img src="/files/static.webp" alt="Static" id="img" />
    </div>

    <script src="socket.io.js"></script>
    <script>
      const socket = io(
        location.protocol + '//' + document.domain + ':' + location.port
      )
      let clips = []

      socket.on('connect', () => {
        console.log('connected')
        // Fetch clip list
      })

      // valid_statuses = ['Clips', 'Live', 'Rebooting', 'Stopped']
      socket.on('status', (status) => {
        console.log('status: ' + status)
        const liveVideo = document.getElementById('liveVideo')
        const aiVideo = document.getElementById('aiVideo')
        const clipVideo = document.getElementById('clipVideo')
        const img = document.getElementById('img')

        switch (status) {
          case 'Clips':
            img.style['z-index'] = -1
            playClip()
            break
          case 'Live':
            liveVideo.style['z-index'] = 2
            aiVideo.style['z-index'] = -1
            clipVideo.style['z-index'] = -1
            img.style['z-index'] = -1
            break
          case 'AI':
            aiVideo.style['z-index'] = 2
            liveVideo.style['z-index'] = -1
            clipVideo.style['z-index'] = -1
            img.style['z-index'] = -1
            break
          case 'Stopped':
            liveVideo.pause()
            aiVideo.pause()
            clipVideo.pause()
            img.style['z-index'] = 2
            break
        }
      })

      socket.on('disconnect', () => {
        console.log('disconnected')
      })

      function playClip() {
        if (clips.length === 0) {
          return fetch('/files/clips')
            .then((res) => {
              return res.json()
            })
            .then((data) => {
              clips = data
              console.log(clips)
              // Shuffle clips
              clips.sort(() => Math.random() - 0.5)
              // Play first clip
              playClip()
            })
        } else {
          // Play clip
          const video = document.getElementById('video')
          const clip = clips.pop()
          video.src = 'files/clip/' + clip
          video.play()
          video.addEventListener('ended', () => {
            document
              .getElementById('video')
              .removeEventListener('ended', () => {
                playClip()
              })
            playClip()
          })
        }
      }

      function startLiveStream() {
        const liveVideo = document.getElementById('liveVideo')
        navigator.mediaDevices
          .getUserMedia({ video: true })
          .then((stream) => {
            liveVideo.srcObject = stream
            liveVideo.play()
          })
          .catch((err) => {
            console.error('Error accessing live webcam: ', err)
          })
      }

      function startAIStream() {
        const aiVideo = document.getElementById('aiVideo')
        // Replace with your AI stream source
        aiVideo.src = 'your_ai_stream_source'
        aiVideo.play()
      }

      // List all available media devices
      navigator.mediaDevices.enumerateDevices().then((devices) => {
        // Filter video devices
        const videoDevices = devices.filter(
          (device) => device.kind === 'videoinput'
        )
        console.log('Available video devices: ', videoDevices)
      })

      startLiveStream()
      startAIStream()
    </script>
  </body>
</html>
